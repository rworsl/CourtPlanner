{% extends "base.html" %}

{% block title %}Dashboard - Badminton Court Planner{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="container">
            <div class="header-content">
                <div class="header-info">
                    <h1 class="dashboard-title">
                        <i class="fas fa-shuttlecock"></i>
                        <span id="clubName">Loading...</span>
                    </h1>
                    <p class="dashboard-subtitle">Club Management Dashboard</p>
                </div>
                <div class="header-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMembers">0</div>
                        <div class="stat-label">Members</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalGames">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="playerElo">1200</div>
                        <div class="stat-label">Your ELO</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="dashboard-nav">
        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="overview">
                    <i class="fas fa-chart-line"></i> Overview
                </button>
                <button class="nav-tab" data-section="members">
                    <i class="fas fa-users"></i> Members
                </button>
                <button class="nav-tab" data-section="courts">
                    <i class="fas fa-volleyball-ball"></i> Court Organization
                </button>
                <button class="nav-tab" data-section="games">
                    <i class="fas fa-gamepad"></i> Games & Recording
                </button>
                <button class="nav-tab" data-section="rankings">
                    <i class="fas fa-trophy"></i> Rankings
                </button>
                <button class="nav-tab" data-section="tournament">
                    <i class="fas fa-trophy"></i> Tournament
                </button>
                <button class="nav-tab" data-section="subscription">
                    <i class="fas fa-crown"></i> Subscription
                </button>
                <!-- Add this button in the subscription section for subscribed users -->
                <button class="btn btn-secondary" onclick="manageSubscription()" id="manageSubBtn" style="display: none;">
                    <i class="fas fa-cog"></i> Manage Subscription
                </button>
            </div>
        </div>
    </div>

    <!-- Demo Timer Warning (only shown for demo club) -->
    <div id="demoTimerBar" style="display: none;">
        <div class="container">
            <div class="demo-timer-alert">
                <div class="demo-timer-content">
                    <i class="fas fa-clock"></i>
                    <span>Demo Mode - Time Remaining: <strong id="demoTimeRemaining">01:00</strong></span>
                </div>
                <div class="demo-timer-info">
                    All changes will reset when time expires
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="dashboard-main">
        <div class="container">
            <div id="alertContainer"></div>

            <!-- Overview Section -->
            <div id="overview" class="dashboard-section active">
                <div class="section-header">
                    <h2>Club Overview</h2>
                    <p>Welcome back! Here's what's happening in your club.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="overviewMembers">0</div>
                            <div class="stat-label">Active Members</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="overviewGames">0</div>
                            <div class="stat-label">Total Games</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="avgElo">1200</div>
                            <div class="stat-label">Average ELO</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-volleyball-ball"></i>
                        </div>
                        <div class="stat-details">
                            <div class="stat-value" id="courtsCount">4</div>
                            <div class="stat-label">Courts Available</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Games -->
                <div class="card">
                    <div class="card-header">
                        <h3>Recent Games</h3>
                    </div>
                    <div class="card-body">
                        <div id="recentGames">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i> Loading recent games...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div id="members" class="dashboard-section">
                <div class="section-header">
                    <h2>Club Members</h2>
                    <button class="btn btn-primary" onclick="showAddMemberModal()" id="addMemberBtn">
                        <i class="fas fa-plus"></i> Add Member
                    </button>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="membersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>ELO Rating</th>
                                        <th>Games Played</th>
                                        <th>Win Rate</th>
                                        <th>Role</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading members...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Court Organization Section -->
            <div id="courts" class="dashboard-section">
                <div class="section-header">
                    <h2>Court Organization</h2>
                    <p>Manage courts and organize play sessions</p>
                </div>

                <!-- Court Settings -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3>Court Settings</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-2">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-volleyball-ball"></i> Number of Courts
                                </label>
                                <input type="number" id="courtCountInput" class="form-input" min="1" max="20" value="4">
                            </div>
                            <div class="form-group" style="display: flex; align-items: flex-end;">
                                <button class="btn btn-primary" onclick="updateCourtCount()">
                                    <i class="fas fa-save"></i> Update Courts
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Players Selection -->
                <div class="card mb-3">
                    <div class="card-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3>Active Players Today</h3>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-sm btn-success" onclick="selectAllPlayers()">
                                    <i class="fas fa-check-double"></i> Select All
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="deselectAllPlayers()">
                                    <i class="fas fa-times"></i> Deselect All
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <p class="form-subtitle">
                            Select players who are present for today's session 
                            <span id="activePlayerCount" class="badge badge-primary" style="margin-left: 0.5rem;">0 selected</span>
                        </p>
                        <div id="activePlayersGrid" class="active-players-grid">
                            <div class="loading-state">
                                <i class="fas fa-spinner fa-spin"></i> Loading members...
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-success" onclick="generateMatches()">
                                <i class="fas fa-random"></i> Generate Balanced Matches
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Court Assignments -->
                <div class="card">
                    <div class="card-header">
                        <h3>Current Court Assignments</h3>
                    </div>
                    <div class="card-body">
                        <div id="courtAssignments">
                            <p class="text-center text-secondary">Select active players and generate matches to see court assignments</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Games & Recording Section (MERGED) -->
            <div id="games" class="dashboard-section">
                <div class="section-header">
                    <h2>Games & Recording</h2>
                    <p>Record new matches and view game history</p>
                </div>

                <!-- Record Game Card -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h3>Record New Game</h3>
                    </div>
                    <div class="card-body">
                        <form id="recordGameForm">
                            <div class="grid grid-cols-2">
                                <!-- Team 1 -->
                                <div class="team-section">
                                    <h3>Team 1</h3>
                                    <div class="form-group">
                                        <label class="form-label">Player 1</label>
                                        <select class="form-select" name="team1_player1" required>
                                            <option value="">Select player...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Player 2</label>
                                        <select class="form-select" name="team1_player2" required>
                                            <option value="">Select player...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Score</label>
                                        <input type="number" class="form-input" name="team1_score" min="0" max="30" required>
                                    </div>
                                </div>

                                <!-- Team 2 -->
                                <div class="team-section">
                                    <h3>Team 2</h3>
                                    <div class="form-group">
                                        <label class="form-label">Player 1</label>
                                        <select class="form-select" name="team2_player1" required>
                                            <option value="">Select player...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Player 2</label>
                                        <select class="form-select" name="team2_player2" required>
                                            <option value="">Select player...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Score</label>
                                        <input type="number" class="form-input" name="team2_score" min="0" max="30" required>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Court</label>
                                <input type="text" class="form-input" name="court" placeholder="Court number or name">
                            </div>

                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Record Game
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Game History Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>Game History</h3>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="gamesTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Team 1</th>
                                        <th>Score</th>
                                        <th>Team 2</th>
                                        <th>Winner</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading games...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Rankings Section -->
            <div id="rankings" class="dashboard-section">
                <div class="section-header">
                    <div>
                        <h2>Player Rankings</h2>
                        <p>Performance statistics and rankings</p>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        <div class="ranking-toggle">
                            <button class="btn btn-sm btn-secondary ranking-toggle-btn active" data-ranking-type="alltime" onclick="switchRankingView('alltime')">
                                <i class="fas fa-trophy"></i> All-Time
                            </button>
                            <button class="btn btn-sm btn-secondary ranking-toggle-btn" data-ranking-type="session" onclick="switchRankingView('session')">
                                <i class="fas fa-clock"></i> This Session
                            </button>
                        </div>
                        <button class="btn btn-sm btn-primary" id="downloadStatsBtn" onclick="downloadAdvancedStats()">
                            <i class="fas fa-download"></i> Download Stats
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table" id="rankingsTable">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Player</th>
                                        <th id="rankingMetricHeader">ELO Rating</th>
                                        <th>Games Played</th>
                                        <th>Win Rate</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading rankings...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END Rankings Section -->

            <!-- Subscription Section -->
        <div id="subscription" class="dashboard-section">
    <div class="section-header">
        <h2>Subscription & Billing</h2>
        <p>Manage your club's subscription plan and features</p>
    </div>

    <!-- Current Plan -->
    <div class="card mb-3">
        <div class="card-header">
            <h3>Current Plan</h3>
        </div>
        <div class="card-body">
            <div class="current-plan-display">
                <div class="plan-badge">
                    <i class="fas fa-crown"></i>
                    <span id="currentPlanName">Loading...</span>
                </div>
                <div class="plan-details">
                    <div class="plan-detail-item">
                        <i class="fas fa-users"></i>
                        <span id="memberLimit">0</span> / <span id="maxMembers">0</span> Members
                    </div>
                    <div class="plan-detail-item">
                        <i class="fas fa-volleyball-ball"></i>
                        <span id="courtLimit">Unlimited</span> Courts
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Plans -->
    <div class="pricing-grid">
        <!-- Starter Plan -->
        <div class="pricing-card">
            <div class="pricing-header">
                <h3>Starter</h3>
                <div class="pricing-price">
                    <span class="price-amount">Free</span>
                </div>
            </div>
            <div class="pricing-features">
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Up to 10 members</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>2 courts</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Basic tracking</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Simple rankings</span>
                </div>
            </div>
            <button class="btn btn-secondary btn-block" id="freeBtn" disabled>
                Current Plan
            </button>
        </div>

        <!-- Pro Plan -->
        <div class="pricing-card featured">
            <div class="popular-badge">Most Popular</div>
            <div class="pricing-header">
                <h3>Club Pro</h3>
                <div class="pricing-price">
                    <span class="price-currency">$</span>
                    <span class="price-amount">10</span>
                    <span class="price-period">/month</span>
                </div>
            </div>
            <div class="pricing-features">
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Up to 50 members</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Unlimited courts</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>ELO rating system</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Match suggestions</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Basic analytics</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Auto-run sessions</span>
                </div>
            </div>
            <button class="btn btn-primary btn-block" id="proBtn" onclick="upgradePlan('pro')">
                Upgrade to Pro
            </button>
        </div>

        <!-- Elite Plan -->
        <div class="pricing-card">
            <div class="pricing-header">
                <h3>Club Elite</h3>
                <div class="pricing-price">
                    <span class="price-currency">$</span>
                    <span class="price-amount">20</span>
                    <span class="price-period">/month</span>
                </div>
            </div>
            <div class="pricing-features">
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Unlimited members</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Unlimited courts</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>All Pro features</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Advanced analytics</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Tournament mode</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-check"></i>
                    <span>Priority support</span>
                </div>
            </div>
            <button class="btn btn-primary btn-block" id="eliteBtn" onclick="upgradePlan('elite')">
                Upgrade to Elite
            </button>
        </div>
    </div>
</div>

    </div>
</div>

<!-- Tournament Section -->
<div id="tournament" class="dashboard-section">
    <div class="section-header">
        <h2>Tournament Mode</h2>
        <button class="btn btn-primary" onclick="showCreateTournamentModal()" id="createTournamentBtn">
            <i class="fas fa-plus"></i> New Tournament
        </button>
    </div>

    <!-- Tournament List -->
    <div id="tournamentList" class="card mb-3">
        <div class="card-header">
            <h3>Active Tournaments</h3>
        </div>
        <div class="card-body">
            <div id="tournamentsContainer">
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i> Loading tournaments...
                </div>
            </div>
        </div>
    </div>

    <!-- Tournament View (hidden by default) -->
    <div id="tournamentView" style="display: none;">
        <button class="btn btn-secondary mb-3" onclick="backToTournamentList()">
            <i class="fas fa-arrow-left"></i> Back to Tournaments
        </button>

        <div class="card mb-3">
            <div class="card-header">
                <h3 id="tournamentViewName">Tournament Name</h3>
                <span id="tournamentViewStatus" class="badge badge-primary">Status</span>
            </div>
            <div class="card-body">
                <!-- Group Stage -->
                <div id="groupStageView">
                    <h4>Group Stage</h4>
                    <div id="groupsContainer"></div>
                    <button class="btn btn-success mt-3" id="advanceToKnockoutBtn" onclick="advanceToKnockout()" style="display: none;">
                        <i class="fas fa-forward"></i> Advance to Knockout Stage
                    </button>
                </div>

                <!-- Knockout Stage -->
                <div id="knockoutStageView" style="display: none;">
                    <h4>Knockout Stage</h4>
                    <div id="knockoutBracketContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Tournament Modal -->
<div id="createTournamentModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3>Create New Tournament</h3>
            <button class="modal-close" onclick="hideCreateTournamentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="createTournamentForm">
                <div class="form-group">
                    <label class="form-label">Tournament Name</label>
                    <input type="text" class="form-input" name="name" placeholder="e.g., Summer Championship 2024" required>
                </div>

                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Number of Groups</label>
                        <select class="form-select" name="num_groups" id="numGroupsSelect">
                            <option value="2">2 Groups</option>
                            <option value="3">3 Groups</option>
                            <option value="4">4 Groups</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Knockout Rounds</label>
                        <select class="form-select" name="knockout_rounds">
                            <option value="1">Final Only</option>
                            <option value="2" selected>Semi-Finals + Final</option>
                            <option value="3">Quarter-Finals + Semi-Finals + Final</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Select Teams (Pairs)</label>
                    <div id="teamSelectionContainer"></div>
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addTeamRow()">
                        <i class="fas fa-plus"></i> Add Team
                    </button>
                </div>

                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-trophy"></i> Create Tournament
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div id="addMemberModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Member</h3>
            <button class="modal-close" onclick="hideAddMemberModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <form id="addMemberForm">
                <div class="form-group">
                    <label class="form-label">Member Name</label>
                    <input type="text" class="form-input" name="name" placeholder="Enter member name" required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Member
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}